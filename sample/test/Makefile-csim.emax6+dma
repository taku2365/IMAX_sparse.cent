
## EMAX5/6 Application Simulator       ##
##   Copyright (C) 2014 by NAIST UNIV. ##
##         Primary writer: Y.Nakashima ##
##                nakashim@is.naist.jp ##

## -DEMAX5     ... with emaxnc/emax
## -DEMAX6     ... with emaxnc/emax
## -DARMSIML   ... with bsim/csim
## -DARMZYNQ   ... with ZYNQ

## Makefile              native        : none
## Makefile.emax5nc      native+EMAX5NC: -DEMAX5
## Makefile.emax6nc      native+EMAX6NC: -DEMAX6

## Makefile-bsim         bsim          : -DARMSIML
## Makefile-bsim.emax5nc bsim+EMAX5NC  : -DARMSIML -DEMAX5
## Makefile-bsim.emax5   bsim+EMAX5    : -DARMSIML -DEMAX5 emax5_start->emax_start->syscall
## Makefile-zynq.emax5nc(ZYNQ+EMAX5NC  : -DARMZYNQ -DEMAX5)
## Makefile-zynq.emax5  (ZYNQ+EMAX5HW  : -DARMZYNQ -DEMAX5) emax5_start->udev_write

## Makefile-csim         csim          : -DARMSIML
## Makefile-csim.emax6nc csim+EMAX6NC  : -DARMSIML -DEMAX6
## Makefile-csim.emax6   csim+EMAX6    : -DARMSIML -DEMAX6 emax6_start->emax_start->syscall
## Makefile-zynq.emax6nc(ZYNQ+EMAX6NC  : -DARMZYNQ -DEMAX6)
## Makefile-zynq.emax6  (ZYNQ+EMAX6HW  : -DARMZYNQ -DEMAX6) emax6_start->udev_write

PROJTOP	      = ../../
IMAX_DEBUG    = 0
OPTION	      = -mstrict-align -DDEBUG -DCYCLECNT -DARMSIML -DEMAX6 -DFPDDMA
PROGRAM       =	 test024-csim.emax6+dma
#PROGRAM       =	 test022-csim.emax6+dma
CPP           = ../../bin/aarch64-elf-cpp -P
CC            = ../../bin/aarch64-elf-gcc

ifeq ($(IMAX_DEBUG),1)
CFLAGS = -I. -O0 -g3 -Wno-attributes $(OPTION)	
else 	
CFLAGS = -I. -O3 -Wno-attributes $(OPTION) -fno-exceptions
endif
AS            = ../../bin/aarch64-elf-as
ASFLAGS       = 
LD            = ../../bin/aarch64-elf-ld
LDFLAGS       =	-static -M $(PROJTOP)/lib/asim64-lib/_map
LIBS          =	-lgcc -lm -lc -lsparse
LIBFLAGS      = -L$(PROJTOP)/lib/gcc/aarch64-elf/4.8.2/ -L$(PROJTOP)/aarch64-elf/lib/ -L../../src/emax6_sparselib/
OBJS          = test024-emax6.o 
SRCS          = test024.c
#OBJS          = test022-emax6.o
#SRCS          = test022.c
INCLUDE = -I../../src/emax6_sparselib/Include


all:		$(PROGRAM)

test024-csim.emax6+dma:		test024-emax6.o
		$(LD) $(INCLUDE) $(LDFLAGS) -o $@ $(PROJTOP)/lib/asim64-lib/_start.o $< $(LIBFLAGS) --start-group $(LIBS) --end-group

test024-emax6.o: test024-emax6.c sparse_lib
		$(CC) $(CFLAGS) $(INCLUDE) -c $<

test024-emax6.c: test024.c 
		perl $(PROJTOP)/src/conv-mark/conv-mark $< > $<-mark.c
		$(CPP) $(OPTION) $(INCLUDE) $<-mark.c > $<-cppo.c
		$(PROJTOP)/src/conv-c2c/conv-c2c $<-cppo.c



#test022-csim.emax6+dma:        test022-emax6.o
#		$(LD) $(LDFLAGS) -o $@ $(PROJTOP)/lib/asim64-lib/_start.o $< $(LIBFLAGS) --start-group $(LIBS) --end-group
#
#test022-emax6.o: test022-emax6.c
#		$(CC) $(CFLAGS) -c $<
#
#test022-emax6.c: test022.c
#		perl $(PROJTOP)/src/conv-mark/conv-mark $< > $<-mark.c
#		$(CPP) $(OPTION) $<-mark.c > $<-cppo.c
#		$(PROJTOP)/src/conv-c2c/conv-c2c $<-cppo.c

###


test024-emax6.o: ../../src/conv-c2c/emax6.h ../../src/conv-c2c/emax6lib.c ../../src/emax6_sparselib/Include/emax6_sparselib.h
#test022-emax6.o: ../../src/conv-c2c/emax6.h ../../src/conv-c2c/emax6lib.c


sparse_lib:
	(cd ../../src/emax6_sparselib; $(MAKE) ARM_CORSS_COMPILE=1 static)
# $(MAKE)はマクロも引き継がれる


clean:		
		rm -f *.o core *~ *-mark.c *-cppo.c *-emax6.c 
		(cd ../../src/emax6_sparselib; $(MAKE) clean)